#!/bin/sh

set -e

directory=$(dirname $0)/../../..
target_directory=$directory/target/release_test

while getopts l: option; do
  case $option in
  l)
    libraries="$libraries $OPTARG"
    ;;
  esac
done

shift $(expr $OPTIND - 1)

script=$1
shift 1

compile() (
  options=$STAK_COMPILE_OPTIONS

  if [ -n "$STAK_HOST" ]; then
    $STAK_HOST $directory/compile.scm $options
  else
    $target_directory/stak-compile $options
  fi
)

cat $directory/prelude.scm $libraries $script | compile >main.bc
$target_directory/stak-interpret main.bc "$@"
